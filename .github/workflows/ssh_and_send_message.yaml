name: SSH Command and Send Telegram Message

on:
  workflow_dispatch:  # 允许手动触发工作流

jobs:
  run_ssh_command:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Execute SSH Command
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -p $SSH_PASSWORD ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST \
            'curl -s https://raw.githubusercontent.com/youqishi1/Sing-box/main/hy2.sh | UUID=248d5250-f57b-47ff-9b42-54120bd2e2ec PORT=1372 NEZHA_SERVER=www.bing.com NEZHA_PORT=5555 NEZHA_KEY=xiaowang bash' \
            > ssh_output.txt

      - name: Send Telegram message
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
import requests
import os

def send_telegram_message(message):
    url = f'https://api.telegram.org/bot{os.getenv('TELEGRAM_BOT_TOKEN')}/sendMessage'
    payload = {
        'chat_id': os.getenv('TELEGRAM_CHAT_ID'),
        'text': message
    }
    headers = {'Content-Type': 'application/json'}
    response = requests.post(url, json=payload, headers=headers)
    if response.status_code != 200:
        raise ValueError(f'Error: {response.status_code} {response.text}')

if __name__ == '__main__':
    with open('ssh_output.txt', 'r') as file:
        message = file.read()
    send_telegram_message(message)
          "
